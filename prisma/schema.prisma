generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   SETTINGS
========================= */
model Setting {
  id     String  @id @default(cuid())
  userId String?
  key    String
  value  String

  @@unique([userId, key])
  @@index([key])
}

/* =========================
   USER
========================= */
model User {
  id            String   @id @default(cuid())
  wallet        String?  @unique
  createdAt     DateTime @default(now())

  pointBalance  PointBalance?
  events        PointEvent[]
  nodes         Node[]

  metricsDaily  MetricsDaily[]
  metricsHourly MetricsHourly[]
}

/* =========================
   NODE (identity ของเครื่องจริง)
========================= */
model Node {
  id            String   @id @default(cuid())
  userId        String

  /// public key ของ node (verify signature)
  publicKey     String   @unique

  fingerprint   String?
  region        String?
  asn           String?

  trustScore    Float    @default(1.0)
  riskScore     Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
  events        PointEvent[]
  heartbeats    NodeHeartbeat[]
  verifierTests VerifierTest[]

  @@index([userId])
}

/* =========================
   POINT EVENT (ledger หลัก)
========================= */
model PointEvent {
  id          String   @id @default(cuid())
  userId      String
  nodeId      String?

  /// UPTIME_MINUTE | VERIFIER_BW | REFERRAL | BONUS | PENALTY | CONVERT_DEBIT
  type        String
  amount      Int

  meta        Json?
  source      String
  ruleVersion String

  dedupeKey   String
  nonce       String?

  signatureOk Boolean  @default(false)
  riskScore   Int      @default(0)

  occurredAt  DateTime
  createdAt   DateTime @default(now())

  user User  @relation(fields: [userId], references: [id])
  node Node? @relation(fields: [nodeId], references: [id])

  @@unique([dedupeKey])
  @@index([userId, occurredAt])
  @@index([nodeId, occurredAt])
  @@index([type, occurredAt])
}

/* =========================
   POINT BALANCE (materialized)
========================= */
model PointBalance {
  userId    String   @id
  balance   Int      @default(0)
  slk       Float    @default(0)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

/* =========================
   SHARING STATE (Start/Stop Sharing)
   - ใช้กับ /api/sharing/status, /api/sharing/toggle, /api/sharing/heartbeat
========================= */
model SharingState {
  id        String   @id @default(cuid())

  // key หลักของ sharing ต่อ 1 wallet
  wallet    String   @unique
  active    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([wallet])
}

/* =========================
   NODE HEARTBEAT (uptime proof)
========================= */
model NodeHeartbeat {
  id          String   @id @default(cuid())
  nodeId      String
  at          DateTime
  latencyMs   Int?
  signatureOk Boolean

  createdAt   DateTime @default(now())

  node Node @relation(fields: [nodeId], references: [id])

  @@unique([nodeId, at])
  @@index([nodeId])
  @@index([at])
}

/* =========================
   VERIFIER BANDWIDTH TEST
========================= */
model VerifierTest {
  id            String   @id @default(cuid())
  nodeId        String

  startedAt     DateTime
  finishedAt    DateTime

  downloadMbps  Float
  uploadMbps    Float
  latencyMs     Float
  jitterMs      Float?
  packetLoss    Float?
  success       Boolean

  createdAt     DateTime @default(now())

  node Node @relation(fields: [nodeId], references: [id])

  @@index([nodeId])
  @@index([nodeId, startedAt])
}

/* =========================
   METRICS (ของเดิม ใช้ต่อ)
========================= */
model MetricsHourly {
  id           String   @id @default(cuid())
  hourUtc      DateTime
  userId       String?
  pointsEarned Int      @default(0)

  uptimePct    Float?
  avgBandwidth Float?
  qfScore      Float?
  trustScore   Float?

  createdAt    DateTime @default(now())
  region       String?
  version      String?

  user User? @relation(fields: [userId], references: [id])

  @@unique([hourUtc, userId], name: "hourUtc_userId_unique")
  @@index([hourUtc])
  @@index([userId])
}

model MetricsDaily {
  id           String   @id @default(cuid())
  dayUtc       DateTime
  userId       String?
  pointsEarned Int      @default(0)

  uptimePct    Float?
  avgBandwidth Float?
  qfScore      Float?
  trustScore   Float?

  createdAt    DateTime @default(now())
  region       String?
  version      String?

  user User? @relation(fields: [userId], references: [id])

  @@unique([dayUtc, userId], name: "dayUtc_userId_unique")
  @@index([dayUtc])
  @@index([userId])
}
